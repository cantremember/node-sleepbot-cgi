#!/bin/bash

source `dirname $0`/common

pushd . > /dev/null
cd $ROOT


npm run compile
CODE=$?

if [[ "$CODE" == "0" ]]; then
    OUTPUT=./build/coverage/lcov.info
    mkdir -p build
    rm -f $OUTPUT

    NODE_ENV=test $NODE_BIN/istanbul cover $NODE_BIN/_mocha $ES5/test -- --reporter dot
    CODE=$?
fi

if [[ "$CODE" == "0" ]]; then
    # https://github.com/cainus/node-coveralls
    cat $OUTPUT | $NODE_BIN/coveralls

    # FIXME:  Bad response: 422 {"message":"Couldn't find a repository matching this job.","error":true}
    #   we are not gonna make CI success dependent upon Coveralls.io
    #   CODE=$?
fi


popd > /dev/null

if [[ "$CODE" != "0" ]]; then
    FAIL "CI failed"
fi

SUCCEED "CI passed!"

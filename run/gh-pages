#!/bin/bash

source `dirname $0`/common

# https://help.github.com/articles/creating-project-pages-manually/
#   ```bash
#   git clone git@github.com:cantremember/node-sleepbot-cgi.git gh-pages
#   cd gh-pages/
#   git checkout --orphan gh-pages
#   git rm -rf .
#   # ...
#   git push -u origin gh-pages
#   ```

pushd . > /dev/null
cd $ROOT

mkdir -p build
rm -rf build/gh-pages
git clone -b gh-pages git@github.com:cantremember/node-sleepbot-cgi.git build/gh-pages
CODE=$?

if [[ "$CODE" == "0" ]]; then
    $NODE_BIN/jsdoc -c $ROOT/.jsdoc.json --destination build/gh-pages
    CODE=$?
fi

CHANGES=0
if [[ "$CODE" == "0" ]]; then
    cd build/gh-pages
    CHANGES=`git diff --name-only --diff-filter=ACM | wc -l | tr -d '[[:space:]]'`
fi

if [[ "$CHANGES" != "0" ]]; then
    STAMP=`date '+%Y-%d-%m %H:%M:%S'`
    git add . && git commit --no-verify -m "gh-pages updated $STAMP" && git push
    CODE=$?
fi

popd > /dev/null

if [[ "$CODE" != "0" ]]; then
    FAIL "failed to update gh-pages"
fi

rm -rf build/gh-pages
SUCCEED "gh-pages updated!"

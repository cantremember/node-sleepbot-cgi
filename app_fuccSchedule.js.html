<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>cantremember/node-sleepbot-cgi - Source: app/fuccSchedule.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<a href="https://github.com/cantremember/node-sleepbot-cgi"><img
    style="position: fixed; top: 0; right: 0; border: 0;"
    src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67"
    alt="Fork me on GitHub"
    data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"
></a>

<div id="main">
    <h1 class="page-title">Source: app/fuccSchedule.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

// jshint -W079
var Promise = require('bluebird');
// jshint +W079
var theLib = require('../lib/index');

// // TODO: timezone support
// const timeZoneOffset = 0;

// column -> index mapping
var liveColumns = theLib.columnToIndexMap('file anchor year month day hourStart hourEnd');
var showColumns = theLib.columnToIndexMap('file anchor dayOfWeek hourStart hourEnd');
var quipColumns = theLib.columnToIndexMap('text');
var dayOfWeekNames = 'Sunday Monday Tuesday Wednesday Thursday Friday Saturday'.split(/\s/); // 0-based
var dayOfWeekAnchors = 'SUN MON TUE WED THU FRI SAT'.split(/\s/); // 0-based

var NO_QUIPS = Object.freeze([[]]);
var FAKE_QUIP = Object.freeze({ text: '' });

function coerceData(data) {
    // FIXME:  TypeError: Property '@@iterator' of object"
    //   for (let key of Object.keys(data)) {
    var keys = Object.keys(data);
    for (var i = 0, key = undefined; i &lt; keys.length; ++i) {
        key = keys[i];

        switch (key) {
            case 'file':
            case 'anchor':
                break;
            default:
                // numeric properties
                data[key] = parseInt(data[key], 10);
        }
    }
    return data;
}

function scrapeBodyTitle(data, lines, start, titleStart, /* optional */end) {
    if (end === undefined) {
        var _temp = [titleStart, undefined];
        end = _temp[0];
        titleStart = _temp[1];
        _temp;
    }

    var body = [];
    var phase = 0;

    // FIXME:  TypeError: Property '@@iterator' of object"
    //   for (let line of lines) {
    for (var i = 0, line = undefined; i &lt; lines.length; ++i) {
        line = lines[i];

        switch (phase) {
            case 0:
                // searching
                if (start.test(line)) {
                    // the next line starts it
                    phase += 1;
                }
                break;
            case 1:
                // scraping the body
                if (titleStart &amp;&amp; titleStart.test(line)) {
                    // the next line starts it
                    phase += 1;
                } else if (end.test(line)) {
                    // that's the end of it
                    phase = 4;
                } else {
                    body.push(line);
                }
                break;
            case 2:
                // scraping the single-line title
                data.title = line;

                // and the rest is body
                phase += 1;
                break;
            case 3:
                // scraping the rest of the body
                if (end.test(line)) {
                    // that's the end of it
                    phase += 1;
                } else {
                    body.push(line);
                }
                break;
        }
    }

    // stringify
    data.body = body.join('\n');
    return data;
}

/*
   the dead file
*/
var loadDead = theLib.willMemoize(function () {
    return theLib.wwwRoot.willLoadFile('fucc/dead.txt')['catch']( /* istanbul ignore next */function () {
        // not present
        return undefined;
    });
});

/*
   the live file
*/
function isLiveNow(data, date) {
    // exact date match
    if (data.year !== date.getFullYear() || data.month !== date.getMonth() || data.day !== date.getDate()) {
        return false;
    }
    // and within the hour range
    var hour = date.getHours();
    return hour >= data.hourStart &amp;&amp; hour &lt; data.hourEnd;
}
var loadLives = theLib.willMemoize(function () {
    var datas = undefined;

    return theLib.wwwRoot.willLoadTSV('fucc/live.txt').then(function (rows) {
        // coerce
        datas = rows.map(function (row) {
            var data = coerceData(theLib.dataColumnMap(row, liveColumns));
            data.type = 'live';

            // 2-digit year
            var yy = parseInt(data.year, 10);
            data.year = yy + (yy &lt; 500 ? 1900 : /* istanbul ignore next */0);

            return data;
        });

        // the live schedule, for scrape-age
        return theLib.wwwRoot.willLoadFile('fucc/live.html');
    }).then(function (page) {
        var lines = (page || '').split('\n');

        return datas.map(function (data) {
            return scrapeBodyTitle(data, lines, new RegExp('^&lt;A NAME="' + data.anchor + '">'), /^&lt;A NAME=/);
        });
    });
});
function checkLive(date) {
    // load up the rows
    return loadLives().then(function (datas) {
        // the first one that's live
        return datas &amp;&amp; datas.filter(function (data) {
            return isLiveNow(data, date);
        })[0];
    })['catch'](function () {
        // treat as no match
        return undefined;
    });
}

/*
   the show file
*/
function isShowNow(data, date) {
    // same day of the week (0-based)
    if (data.dayOfWeek !== date.getDay()) {
        return false;
    }
    // and within the hour range
    var hour = date.getHours();
    return hour >= data.hourStart &amp;&amp; hour &lt; data.hourEnd;
}
var loadShows = theLib.willMemoize(function () {
    var datas = undefined;

    return theLib.wwwRoot.willLoadTSV('fucc/show.txt').then(function (rows) {
        // coerce
        datas = rows.map(function (row) {
            var data = coerceData(theLib.dataColumnMap(row, showColumns));
            data.type = 'show';

            return data;
        });

        // the show schedule, for scrape-age
        return theLib.wwwRoot.willLoadFile('fucc/show.html');
    }).then(function (page) {
        var lines = (page || '').split('\n');

        return datas.map(function (data) {
            return scrapeBodyTitle(data, lines, new RegExp('^&lt;A NAME="' + data.anchor + '">'), /^&lt;!-- start -->/, /^&lt;!-- end -->/);
        });
    });
});
function checkShow(date) {
    // load up the rows
    return loadShows().then(function (datas) {
        // the first one that's live
        return datas &amp;&amp; datas.filter(function (data) {
            return isShowNow(data, date);
        })[0];
    })['catch'](function () {
        // treat as no match
        return undefined;
    });
}

/*
   the quip file
*/
var loadQuips = theLib.willMemoize(function () {
    return theLib.wwwRoot.willLoadTSV('fucc/showquip.txt')['catch'](function () {
        return NO_QUIPS;
    });
});

/**
 * Renders on-air status for [F.U.C.C Radio](http://sleepbot.com/fucc/cgi/schednow.cgi)
 *
 * &amp;nbsp;
 *
 * @see http://sleepbot.com/fucc/cgi/schednow.cgi
 * @function app.fuccSchedule
 * @params {express.request} req
 * @params {express.response} res
 * @params {Function} cb a callback invoked to continue down the Express middleware pipeline
 * @returns {Promise&lt;express.response>} a Promise resolving `res`
 */
module.exports = function handler(req, res, cb) {
    var date = new Date(),
        day = date.getDay();
    var dead = undefined,
        current = undefined;
    var quip = undefined;

    return loadDead().then(function (_dead) {
        dead = _dead;
        if (dead || current) {
            // we're done
            return;
        }

        return checkLive(date);
    }).then(function (_live) {
        current = current || _live;
        if (dead || current) {
            // we're done
            return;
        }

        return checkShow(date);
    }).then(function (_show) {
        current = current || _show;

        return loadQuips();
    }).then(function (rows) {
        // choose a random quip
        quip = theLib.dataColumnMap(theLib.chooseAny(rows), quipColumns) || /* istanbul ignore next */FAKE_QUIP;

        return Promise.promisify(res.render, res)('fuccSchedule.ejs', {
            config: theLib.config,
            dead: dead,
            current: current,
            quip: quip,
            date: date,
            dayOfWeekName: dayOfWeekNames[day],
            dayOfWeekAnchor: dayOfWeekAnchors[day] }).then(function (body) {
            res.send(body);
        });
    })['return'](res)['catch'](theLib.callbackAndThrowError(cb));
};
//# sourceMappingURL=../../sourcemaps/app/fuccSchedule.js.map</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="app.html">app</a></li><li><a href="config.html">config</a></li><li><a href="lib.html">lib</a></li><li><a href="lib.wwwRoot.html">wwwRoot</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Array_includes">Array_includes</a></li><li><a href="global.html#String_includes">String_includes</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-beta1</a>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
